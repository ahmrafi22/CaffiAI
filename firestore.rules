rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // users
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    //  admin users 
    match /adminusers/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // cafes - public read, admin write for their own
    match /cafes/{cafeId} {
      // Allow anyone to read all cafes (isActive filtering done in app)
      allow read: if true;
      
      // Allow authenticated admin to create a cafe only if:
      // 1. They are authenticated
      // 2. The ownerAdminId matches their uid
      // 3. They don't already have a cafe (enforced in application logic)
      allow create: if request.auth != null && 
                       request.resource.data.ownerAdminId == request.auth.uid;
      
      // Allow authenticated admin to update only their own cafe
      allow update: if request.auth != null && 
                       resource.data.ownerAdminId == request.auth.uid &&
                       request.resource.data.ownerAdminId == request.auth.uid;
      
      // Allow authenticated admin to delete only their own cafe
      allow delete: if request.auth != null && 
                       resource.data.ownerAdminId == request.auth.uid;
    }

    // menuItems - allow admin to manage menu items for their cafe
    match /menuItems/{itemId} {
      // Helper function to check if the admin owns the cafe
      function ownerOfCafe(cafeId) {
        return request.auth != null && 
               get(/databases/$(database)/documents/cafes/$(cafeId)).data.ownerAdminId == request.auth.uid;
      }
      
      // Allow anyone (authenticated or not) to read menu items
      allow read: if true;
      
      // Allow admin to create menu items for their cafe
      allow create: if request.auth != null && 
                       ownerOfCafe(request.resource.data.cafeId);
      
      // Allow admin to update menu items for their cafe
      allow update: if request.auth != null && 
                       ownerOfCafe(resource.data.cafeId) &&
                       ownerOfCafe(request.resource.data.cafeId);
      
      // Allow admin to delete menu items for their cafe
      allow delete: if request.auth != null && 
                       ownerOfCafe(resource.data.cafeId);
    }

    // orders - customers can create and read their own orders, cafe admins can read/update orders for their cafe
    match /orders/{orderId} {
      // Helper function to check if the admin owns the cafe associated with this order
      function isOwnerAdmin() {
        return request.auth != null && 
               resource.data.ownerAdminId == request.auth.uid;
      }
      
      // Allow authenticated users to read their own orders
      // Also allow cafe owners to read orders for their cafe
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.ownerAdminId == request.auth.uid);
      
      // Allow authenticated users to create orders (must be their own userId)
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own pending orders (e.g., cancel)
      // Allow cafe owners to update order status
      allow update: if request.auth != null && 
                       (resource.data.userId == request.auth.uid || 
                        resource.data.ownerAdminId == request.auth.uid);
      
      // Order items subcollection
      match /items/{itemId} {
        // Allow read if user owns the order or is the cafe owner
        allow read: if request.auth != null && 
                       (get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/orders/$(orderId)).data.ownerAdminId == request.auth.uid);
        
        // Allow create if authenticated (items are created in batch with order, so parent doesn't exist yet)
        // The parent order creation rule already ensures only the user can create their own order
        allow create: if request.auth != null;
      }
    }

    match /globalChat/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
  }
}
